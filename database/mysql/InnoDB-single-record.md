## InnoDB记录存储结构
### InnoDB 简介
InnoDb将数据划为若干个页，以页作为次盼盼和内存之间的交互的基本单位，InnoDB中的页的大小一般为16kb。也就是在一般情况下，一次最少从磁盘中读取16KB的内容到内存中，一次最少把内存中的16KB内容刷新到磁盘中。

### InnoDB行格式
#### 分类
   - Compact
   - Redundant
   - Dynamic
   - Compressed

```
CREATE TABLE demo (
         c1 VARCHAR(10),
         c2 VARCHAR(10) NOT NULL,
         c3 CHAR(10),
         c4 VARCHAR(10)
   ) CHARSET=ascii ROW_FORMAT=COMPACT;
```
#### COMPACT行格式
##### 记录的额外信息
   这部分信息是服务器为了描述这条记录而不得不额外添加的一些信息
###### 变长字段长度列表
   VARCHAR(M)、VARBINARY(M)、各种TEXT类型，各种BLOB类型，我们也可以把拥有这些数据类型的列称为变长字段,它们真正的存储空间分为两个部分:**真正的数据内容和占用的字节数**
   把所有变长字段的真实数据占用的字节长度都存放在记录的开头部位，从而形成一个变长字段长度列表，各变长字段数据占用的字节数按照列的顺序逆序存放。

   InnoDB有它的一套规则，我们首先声明一下W、M和L的意思：

   假设某个字符集中表示一个字符最多需要使用的字节数为W，也就是使用SHOW CHARSET语句的结果中的Maxlen列，比方说utf8字符集中的W就是3，gbk字符集中的W就是2，ascii字符集中的W就是1。

   对于变长类型VARCHAR(M)来说，这种类型表示能存储最多M个字符（注意是字符不是字节），所以这个类型能表示的字符串最多占用的字节数就是M×W。

   假设它实际存储的字符串占用的字节数是L。

   所以确定使用1个字节还是2个字节表示真正字符串占用的字节数的规则就是这样：

   - 如果M×W <= 255，那么使用1个字节来表示真正字符串占用的字节数
   - 如果M×W > 255，则分为两种情况：

      - 如果L <= 127，则用1个字节来表示真正字符串占用的字节数。

      - 如果L > 127，则用2个字节来表示真正字符串占用的字节数。
   
###### NULL值列表
   表中的某些列可能存储NULL值，如果把这些NULL值都放到记录的真实数据中存储会很占地方，所以Compact行格式把这些值为NULL的列统一管理起来，存储到NULL值列表中。
   如果表中没有允许存储NULL的列，则NULL值列表也不存在了，否则将每个允许存储NULL的列对应一个二进制位，二进制位按照列的顺序逆序排列，二进制位表示的意义如下：
   - 二进制位的值为1时，代表该列的值为NULL。
   - 二进制位的值为0时，代表该列的值不为NULL。

###### 记录头信息
它是由固定的5个字节组成。5个字节也就是40个二进制位，不同的位代表不同的意思。
|  名称   | 大小（单位：bit）  | 描述 |
|  ----  | ----  | ----|
|预留位1|1|没有使用|
|预留位2|2|没有使用|
|delete_mask|1|标记该记录是否被删除|
|min_rec_mask|1|B+树的每层非叶子节点中的最小记录都会添加该标记|
|n_owned|4|表示当前记录拥有的记录数|
|heap_no|13|表示当前记录在记录堆的位置信息|
|record_type|3|表示当前记录的类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录|
|next_record|16|表示下一条记录的相对位置|

###### 记录的真实数据
MySQL会为每个记录默认的添加一些列,具体的列如下:
|列名|是否必须|占用空间|描述|
|----|---- |---- |---- |
|row_id|否|6字节|行ID，唯一标识一条记录|
|transaction_id|是|6字节|事务ID|
|roll_pointer|是|7字节|回滚指针|

InnoDB表对主键的生成策略：优先使用用户自定义主键作为主键，如果用户没有定义主键，则选取一个Unique键作为主键，如果表中连Unique键都没有定义的话，则InnoDB会为表默认添加一个名为row_id的隐藏列作为主键。所以我们从上表中可以看出：InnoDB存储引擎会为每条记录都添加 transaction_id 和 roll_pointer 这两个列，但是 row_id 是可选的（在没有自定义主键以及Unique键的情况下才会添加该列)。




